{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "1070807882901381553"
    }
  },
  "parameters": {
    "azureMLWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Azure ML Workspace name"
      }
    },
    "containerRegistryName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name (must be globally unique, alphanumeric)"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for resources"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to resources"
      }
    },
    "enableAzureML": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Azure ML deployment"
      }
    },
    "storageAccountId": {
      "type": "string",
      "metadata": {
        "description": "Storage account resource ID for ML workspace"
      }
    },
    "keyVaultId": {
      "type": "string",
      "metadata": {
        "description": "Key Vault resource ID for ML workspace"
      }
    },
    "appInsightsId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Application Insights resource ID for ML workspace"
      }
    }
  },
  "resources": [
    {
      "condition": "[parameters('enableAzureML')]",
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-01-01-preview",
      "name": "[parameters('containerRegistryName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "adminUserEnabled": true
      }
    },
    {
      "condition": "[parameters('enableAzureML')]",
      "type": "Microsoft.MachineLearningServices/workspaces",
      "apiVersion": "2023-04-01",
      "name": "[parameters('azureMLWorkspaceName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "friendlyName": "AOS ML Workspace",
        "storageAccount": "[parameters('storageAccountId')]",
        "keyVault": "[parameters('keyVaultId')]",
        "applicationInsights": "[if(not(empty(parameters('appInsightsId'))), parameters('appInsightsId'), null())]",
        "containerRegistry": "[if(parameters('enableAzureML'), resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), null())]",
        "publicNetworkAccess": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName'))]"
      ]
    }
  ],
  "outputs": {
    "containerRegistryId": {
      "type": "string",
      "metadata": {
        "description": "Container Registry resource ID"
      },
      "value": "[if(parameters('enableAzureML'), resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '')]"
    },
    "containerRegistryName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name"
      },
      "value": "[if(parameters('enableAzureML'), parameters('containerRegistryName'), '')]"
    },
    "azureMLWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Azure ML Workspace resource ID"
      },
      "value": "[if(parameters('enableAzureML'), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('azureMLWorkspaceName')), '')]"
    },
    "azureMLWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Azure ML Workspace name"
      },
      "value": "[if(parameters('enableAzureML'), parameters('azureMLWorkspaceName'), '')]"
    }
  }
}