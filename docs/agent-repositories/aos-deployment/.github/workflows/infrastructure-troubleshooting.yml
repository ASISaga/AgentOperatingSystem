name: Infrastructure Troubleshooting

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to troubleshoot'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      issue_type:
        description: 'Type of issue'
        required: true
        type: choice
        options:
          - deployment_failure
          - performance_degradation
          - connectivity_issue
          - resource_error
          - custom_diagnostic
      resource_name:
        description: 'Specific resource to troubleshoot (optional)'
        required: false
        type: string
      description:
        description: 'Issue description'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  # ============================================================================
  # DIAGNOSTICS COLLECTION
  # ============================================================================
  collect-diagnostics:
    name: Collect Diagnostics
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ steps.setup.outputs.resource_group }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup
        id: setup
        run: |
          echo "resource_group=rg-aos-${{ inputs.environment }}" >> $GITHUB_OUTPUT
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Collect resource group info
        run: |
          RESOURCE_GROUP="${{ steps.setup.outputs.resource_group }}"
          
          echo "# Resource Group Information" > diagnostics.txt
          echo "" >> diagnostics.txt
          
          # Check if resource group exists
          if az group show --name $RESOURCE_GROUP &>/dev/null; then
            echo "✅ Resource group exists" >> diagnostics.txt
            echo "" >> diagnostics.txt
            
            # Get resource group details
            echo "## Resource Group Details" >> diagnostics.txt
            az group show --name $RESOURCE_GROUP >> diagnostics.txt 2>&1
            echo "" >> diagnostics.txt
            
            # List all resources
            echo "## All Resources" >> diagnostics.txt
            az resource list --resource-group $RESOURCE_GROUP -o table >> diagnostics.txt 2>&1
          else
            echo "❌ Resource group does not exist" >> diagnostics.txt
          fi
      
      - name: Collect deployment history
        run: |
          RESOURCE_GROUP="${{ steps.setup.outputs.resource_group }}"
          
          echo "" >> diagnostics.txt
          echo "## Recent Deployments" >> diagnostics.txt
          
          az deployment group list \
            --resource-group $RESOURCE_GROUP \
            --query "[?properties.provisioningState!='Succeeded'].{name:name, state:properties.provisioningState, timestamp:properties.timestamp, error:properties.error.message}" \
            -o table >> diagnostics.txt 2>&1 || echo "No deployment history found" >> diagnostics.txt
      
      - name: Collect activity logs
        run: |
          RESOURCE_GROUP="${{ steps.setup.outputs.resource_group }}"
          
          echo "" >> diagnostics.txt
          echo "## Recent Activity Logs (last 24 hours)" >> diagnostics.txt
          
          START_TIME=$(date -u -d '24 hours ago' +"%Y-%m-%dT%H:%M:%SZ")
          
          az monitor activity-log list \
            --resource-group $RESOURCE_GROUP \
            --start-time $START_TIME \
            --query "[?level=='Error' || level=='Warning'].{time:eventTimestamp, level:level, operation:operationName.localizedValue, status:status.localizedValue}" \
            -o table >> diagnostics.txt 2>&1 || echo "No activity logs found" >> diagnostics.txt
      
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-general
          path: diagnostics.txt
          retention-days: 90

  # ============================================================================
  # DEPLOYMENT FAILURE ANALYSIS
  # ============================================================================
  analyze-deployment-failure:
    name: Analyze Deployment Failure
    runs-on: ubuntu-latest
    needs: collect-diagnostics
    if: inputs.issue_type == 'deployment_failure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Analyze failed deployments
        run: |
          RESOURCE_GROUP="${{ needs.collect-diagnostics.outputs.resource_group }}"
          
          echo "# Deployment Failure Analysis" > deployment-analysis.txt
          echo "" >> deployment-analysis.txt
          
          # Get failed deployments
          FAILED_DEPLOYMENTS=$(az deployment group list \
            --resource-group $RESOURCE_GROUP \
            --query "[?properties.provisioningState=='Failed'].name" \
            -o tsv 2>/dev/null || echo "")
          
          if [[ -z "$FAILED_DEPLOYMENTS" ]]; then
            echo "No failed deployments found in the last runs" >> deployment-analysis.txt
          else
            echo "## Failed Deployments" >> deployment-analysis.txt
            echo "" >> deployment-analysis.txt
            
            for DEPLOYMENT in $FAILED_DEPLOYMENTS; do
              echo "### Deployment: $DEPLOYMENT" >> deployment-analysis.txt
              echo "" >> deployment-analysis.txt
              
              # Get deployment details
              az deployment group show \
                --name $DEPLOYMENT \
                --resource-group $RESOURCE_GROUP \
                --query "{state:properties.provisioningState, timestamp:properties.timestamp, duration:properties.duration, error:properties.error}" \
                -o json >> deployment-analysis.txt 2>&1
              
              echo "" >> deployment-analysis.txt
              
              # Get deployment operations
              echo "#### Failed Operations:" >> deployment-analysis.txt
              az deployment operation group list \
                --name $DEPLOYMENT \
                --resource-group $RESOURCE_GROUP \
                --query "[?properties.provisioningState=='Failed'].{operation:properties.targetResource.resourceName, error:properties.statusMessage.error}" \
                -o json >> deployment-analysis.txt 2>&1
              
              echo "" >> deployment-analysis.txt
            done
          fi
          
          # Check for common deployment issues
          echo "" >> deployment-analysis.txt
          echo "## Common Issue Checks" >> deployment-analysis.txt
          echo "" >> deployment-analysis.txt
          
          # Check quota issues
          echo "### Quota Status" >> deployment-analysis.txt
          az vm list-usage --location eastus --query "[?currentValue >= maximumValue].{name:localName, current:currentValue, max:maximumValue}" -o table >> deployment-analysis.txt 2>&1 || echo "Could not check quota" >> deployment-analysis.txt
      
      - name: Generate recommendations
        run: |
          echo "" >> deployment-analysis.txt
          echo "## Recommendations" >> deployment-analysis.txt
          echo "" >> deployment-analysis.txt
          echo "1. Check the error messages above for specific issues" >> deployment-analysis.txt
          echo "2. Verify resource naming conventions and uniqueness" >> deployment-analysis.txt
          echo "3. Ensure sufficient subscription quotas" >> deployment-analysis.txt
          echo "4. Check regional availability of requested resources" >> deployment-analysis.txt
          echo "5. Review parameter values in bicepparam files" >> deployment-analysis.txt
          echo "6. Check for resource dependencies and deployment order" >> deployment-analysis.txt
      
      - name: Upload analysis
        uses: actions/upload-artifact@v4
        with:
          name: deployment-failure-analysis
          path: deployment-analysis.txt
          retention-days: 90

  # ============================================================================
  # PERFORMANCE DIAGNOSTICS
  # ============================================================================
  diagnose-performance:
    name: Diagnose Performance Issues
    runs-on: ubuntu-latest
    needs: collect-diagnostics
    if: inputs.issue_type == 'performance_degradation'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Collect performance metrics
        run: |
          RESOURCE_GROUP="${{ needs.collect-diagnostics.outputs.resource_group }}"
          
          echo "# Performance Diagnostics" > performance-diagnostics.txt
          echo "" >> performance-diagnostics.txt
          
          # Get Function Apps
          FUNCTION_APPS=$(az functionapp list -g $RESOURCE_GROUP --query "[].name" -o tsv 2>/dev/null || echo "")
          
          if [[ -n "$FUNCTION_APPS" ]]; then
            echo "## Function App Performance" >> performance-diagnostics.txt
            
            for APP in $FUNCTION_APPS; do
              echo "" >> performance-diagnostics.txt
              echo "### Function App: $APP" >> performance-diagnostics.txt
              
              # Get metrics for the last 4 hours
              END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              START_TIME=$(date -u -d '4 hours ago' +"%Y-%m-%dT%H:%M:%SZ")
              
              RESOURCE_ID=$(az functionapp show -g $RESOURCE_GROUP -n $APP --query id -o tsv)
              
              # Request count
              echo "#### Request Count (last 4 hours):" >> performance-diagnostics.txt
              az monitor metrics list \
                --resource $RESOURCE_ID \
                --metric "Requests" \
                --start-time $START_TIME \
                --end-time $END_TIME \
                --aggregation Total \
                --interval PT1H \
                -o table >> performance-diagnostics.txt 2>&1 || echo "N/A" >> performance-diagnostics.txt
              
              # Response time
              echo "" >> performance-diagnostics.txt
              echo "#### Average Response Time (last 4 hours):" >> performance-diagnostics.txt
              az monitor metrics list \
                --resource $RESOURCE_ID \
                --metric "AverageResponseTime" \
                --start-time $START_TIME \
                --end-time $END_TIME \
                --aggregation Average \
                --interval PT1H \
                -o table >> performance-diagnostics.txt 2>&1 || echo "N/A" >> performance-diagnostics.txt
              
              # Error rate
              echo "" >> performance-diagnostics.txt
              echo "#### Http Server Errors (last 4 hours):" >> performance-diagnostics.txt
              az monitor metrics list \
                --resource $RESOURCE_ID \
                --metric "Http5xx" \
                --start-time $START_TIME \
                --end-time $END_TIME \
                --aggregation Total \
                --interval PT1H \
                -o table >> performance-diagnostics.txt 2>&1 || echo "N/A" >> performance-diagnostics.txt
            done
          fi
          
          # Recommendations
          echo "" >> performance-diagnostics.txt
          echo "## Performance Recommendations" >> performance-diagnostics.txt
          echo "1. Review Application Insights for detailed telemetry" >> performance-diagnostics.txt
          echo "2. Check for throttling or rate limiting" >> performance-diagnostics.txt
          echo "3. Review consumption plan limits if using serverless" >> performance-diagnostics.txt
          echo "4. Consider scaling up/out if consistent high load" >> performance-diagnostics.txt
          echo "5. Optimize code for better performance" >> performance-diagnostics.txt
      
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: performance-diagnostics
          path: performance-diagnostics.txt
          retention-days: 90

  # ============================================================================
  # CONNECTIVITY DIAGNOSTICS
  # ============================================================================
  diagnose-connectivity:
    name: Diagnose Connectivity Issues
    runs-on: ubuntu-latest
    needs: collect-diagnostics
    if: inputs.issue_type == 'connectivity_issue'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Test connectivity
        run: |
          RESOURCE_GROUP="${{ needs.collect-diagnostics.outputs.resource_group }}"
          
          echo "# Connectivity Diagnostics" > connectivity-diagnostics.txt
          echo "" >> connectivity-diagnostics.txt
          
          # Test Function App connectivity
          FUNCTION_APPS=$(az functionapp list -g $RESOURCE_GROUP --query "[].{name:name, hostname:defaultHostName}" -o tsv 2>/dev/null || echo "")
          
          if [[ -n "$FUNCTION_APPS" ]]; then
            echo "## Function App Connectivity" >> connectivity-diagnostics.txt
            
            while IFS=$'\t' read -r NAME HOSTNAME; do
              echo "" >> connectivity-diagnostics.txt
              echo "### $NAME (https://$HOSTNAME)" >> connectivity-diagnostics.txt
              
              # Test HTTP connectivity
              if timeout 10 curl -f -s -o /dev/null "https://$HOSTNAME"; then
                echo "✅ HTTP endpoint is reachable" >> connectivity-diagnostics.txt
              else
                echo "❌ HTTP endpoint is NOT reachable" >> connectivity-diagnostics.txt
                echo "   - Check if the Function App is running" >> connectivity-diagnostics.txt
                echo "   - Check firewall/NSG rules" >> connectivity-diagnostics.txt
                echo "   - Check DNS resolution" >> connectivity-diagnostics.txt
              fi
              
              # Get app state
              STATE=$(az functionapp show -g $RESOURCE_GROUP -n $NAME --query "state" -o tsv 2>/dev/null || echo "unknown")
              echo "   State: $STATE" >> connectivity-diagnostics.txt
            done <<< "$FUNCTION_APPS"
          fi
          
          # Check Service Bus connectivity
          NAMESPACES=$(az servicebus namespace list -g $RESOURCE_GROUP --query "[].name" -o tsv 2>/dev/null || echo "")
          
          if [[ -n "$NAMESPACES" ]]; then
            echo "" >> connectivity-diagnostics.txt
            echo "## Service Bus Connectivity" >> connectivity-diagnostics.txt
            
            for NAMESPACE in $NAMESPACES; do
              echo "" >> connectivity-diagnostics.txt
              echo "### $NAMESPACE" >> connectivity-diagnostics.txt
              
              # Get namespace status
              STATUS=$(az servicebus namespace show -g $RESOURCE_GROUP -n $NAMESPACE --query "status" -o tsv 2>/dev/null || echo "unknown")
              echo "   Status: $STATUS" >> connectivity-diagnostics.txt
              
              # List queues
              QUEUES=$(az servicebus queue list -g $RESOURCE_GROUP --namespace-name $NAMESPACE --query "[].name" -o tsv 2>/dev/null || echo "")
              if [[ -n "$QUEUES" ]]; then
                echo "   Queues:" >> connectivity-diagnostics.txt
                for QUEUE in $QUEUES; do
                  echo "     - $QUEUE" >> connectivity-diagnostics.txt
                done
              fi
            done
          fi
      
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: connectivity-diagnostics
          path: connectivity-diagnostics.txt
          retention-days: 90

  # ============================================================================
  # RESOURCE ERROR DIAGNOSTICS
  # ============================================================================
  diagnose-resource-error:
    name: Diagnose Resource Errors
    runs-on: ubuntu-latest
    needs: collect-diagnostics
    if: inputs.issue_type == 'resource_error'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Diagnose resource issues
        run: |
          RESOURCE_GROUP="${{ needs.collect-diagnostics.outputs.resource_group }}"
          RESOURCE_NAME="${{ inputs.resource_name }}"
          
          echo "# Resource Error Diagnostics" > resource-diagnostics.txt
          echo "" >> resource-diagnostics.txt
          
          if [[ -n "$RESOURCE_NAME" ]]; then
            echo "## Specific Resource: $RESOURCE_NAME" >> resource-diagnostics.txt
            echo "" >> resource-diagnostics.txt
            
            # Get resource details
            az resource show \
              --resource-group $RESOURCE_GROUP \
              --name $RESOURCE_NAME \
              -o json >> resource-diagnostics.txt 2>&1 || echo "Resource not found" >> resource-diagnostics.txt
          else
            echo "## All Resources Health Status" >> resource-diagnostics.txt
            echo "" >> resource-diagnostics.txt
            
            # List all resources with their status
            az resource list \
              --resource-group $RESOURCE_GROUP \
              --query "[].{name:name, type:type, location:location, provisioningState:provisioningState}" \
              -o table >> resource-diagnostics.txt 2>&1
          fi
          
          # Check for resources in failed state
          echo "" >> resource-diagnostics.txt
          echo "## Resources in Failed State" >> resource-diagnostics.txt
          az resource list \
            --resource-group $RESOURCE_GROUP \
            --query "[?provisioningState=='Failed'].{name:name, type:type}" \
            -o table >> resource-diagnostics.txt 2>&1
      
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: resource-error-diagnostics
          path: resource-diagnostics.txt
          retention-days: 90

  # ============================================================================
  # GENERATE TROUBLESHOOTING REPORT
  # ============================================================================
  generate-report:
    name: Generate Troubleshooting Report
    runs-on: ubuntu-latest
    needs: [collect-diagnostics, analyze-deployment-failure, diagnose-performance, diagnose-connectivity, diagnose-resource-error]
    if: always()
    steps:
      - name: Download all diagnostics
        uses: actions/download-artifact@v4
        with:
          pattern: '*-diagnostics*'
          merge-multiple: true
      
      - name: Generate comprehensive report
        run: |
          echo "# Troubleshooting Report" > troubleshooting-report.md
          echo "" >> troubleshooting-report.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> troubleshooting-report.md
          echo "**Environment**: ${{ inputs.environment }}" >> troubleshooting-report.md
          echo "**Issue Type**: ${{ inputs.issue_type }}" >> troubleshooting-report.md
          echo "**Description**: ${{ inputs.description }}" >> troubleshooting-report.md
          echo "" >> troubleshooting-report.md
          
          # Include all collected diagnostics
          for file in *-diagnostics.txt diagnostics.txt *-analysis.txt; do
            if [[ -f "$file" ]]; then
              echo "---" >> troubleshooting-report.md
              cat "$file" >> troubleshooting-report.md
              echo "" >> troubleshooting-report.md
            fi
          done
          
          echo "---" >> troubleshooting-report.md
          echo "" >> troubleshooting-report.md
          echo "## Next Steps" >> troubleshooting-report.md
          echo "1. Review the diagnostics above" >> troubleshooting-report.md
          echo "2. Check Azure portal for additional details" >> troubleshooting-report.md
          echo "3. Review Application Insights logs" >> troubleshooting-report.md
          echo "4. Consult troubleshooting skill documentation" >> troubleshooting-report.md
          echo "5. Create an issue if problem persists" >> troubleshooting-report.md
      
      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: troubleshooting-report
          path: troubleshooting-report.md
          retention-days: 90
      
      - name: Post summary
        run: |
          echo "# Troubleshooting Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Issue Type**: ${{ inputs.issue_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Diagnostics Collected" >> $GITHUB_STEP_SUMMARY
          echo "- General diagnostics: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Issue-specific analysis: ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the troubleshooting report artifact for complete details." >> $GITHUB_STEP_SUMMARY
