name: Code Quality - Comprehensive

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - '.github/workflows/code-quality.yml'
      - '.pre-commit-config.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - '.github/workflows/code-quality.yml'
      - '.pre-commit-config.yaml'

jobs:
  formatting:
    name: Code Formatting (Black & isort)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-formatting-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-formatting-
    
    - name: Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort
    
    - name: Check Black formatting
      run: |
        black --check --diff src/ tests/ function_app.py
    
    - name: Check isort import sorting
      run: |
        isort --check-only --diff src/ tests/ function_app.py
    
    - name: Generate formatting report
      if: failure()
      run: |
        echo "## âŒ Formatting Issues Found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Run the following commands to fix:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "black src/ tests/ function_app.py" >> $GITHUB_STEP_SUMMARY
        echo "isort src/ tests/ function_app.py" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  linting:
    name: Linting (Pylint & Flake8)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-linting-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-linting-${{ matrix.python-version }}-
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install pylint flake8
    
    - name: Run Pylint
      run: |
        pylint src/AgentOperatingSystem --exit-zero --output-format=text | tee pylint-report.txt
        echo "### Pylint Results (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tail -20 pylint-report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Run Flake8
      run: |
        flake8 src/ tests/ function_app.py \
          --max-line-length=120 \
          --extend-ignore=E203,W503,E501 \
          --exclude=.git,__pycache__,build,dist,knowledge,data \
          --statistics --count | tee flake8-report.txt || true
        echo "### Flake8 Results (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat flake8-report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Check Pylint score
      if: matrix.python-version == '3.10'
      run: |
        SCORE=$(pylint src/AgentOperatingSystem --exit-zero | grep "rated at" | awk '{print $7}' | cut -d'/' -f1)
        echo "## ðŸ“Š Pylint Score: $SCORE/10.00" >> $GITHUB_STEP_SUMMARY
        pylint src/AgentOperatingSystem --fail-under=9.0
    
    - name: Upload linting results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: linting-results-${{ matrix.python-version }}
        path: |
          pylint-report.txt
          flake8-report.txt
        retention-days: 30

  type-checking:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-mypy-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-mypy-
    
    - name: Install mypy and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mypy types-requests types-PyYAML
    
    - name: Run mypy
      run: |
        mypy src/AgentOperatingSystem --config-file=pyproject.toml --no-error-summary 2>&1 | tee mypy-report.txt || true
        echo "### mypy Type Checking Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        head -50 mypy-report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Upload mypy results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: mypy-results
        path: mypy-report.txt
        retention-days: 30

  security:
    name: Security Scanning (Bandit & Safety)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-security-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-security-
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety
    
    - name: Run Bandit
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt | tee bandit-report.txt || true
        echo "### ðŸ”’ Bandit Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tail -30 bandit-report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Run Safety (Dependency Vulnerability Scan)
      run: |
        # Generate requirements from pyproject.toml
        pip install . || true
        pip freeze > requirements-freeze.txt
        safety check --file requirements-freeze.txt --json > safety-report.json || true
        safety check --file requirements-freeze.txt | tee safety-report.txt || true
        echo "### ðŸ›¡ï¸ Safety Dependency Scan Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat safety-report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Upload security results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-results
        path: |
          bandit-report.json
          bandit-report.txt
          safety-report.json
          safety-report.txt
        retention-days: 30

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [formatting, linting, type-checking, security]
    if: always()
    
    steps:
    - name: Check Quality Gate
      run: |
        echo "## ðŸŽ¯ Code Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.formatting.result }}" == "success" ]; then
          echo "âœ… Formatting: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Formatting: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.linting.result }}" == "success" ]; then
          echo "âœ… Linting: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Linting: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.type-checking.result }}" == "success" ]; then
          echo "âœ… Type Checking: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Type Checking: INFORMATIONAL" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security.result }}" == "success" ]; then
          echo "âœ… Security: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Security: NEEDS REVIEW" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Fail if formatting or linting failed
        if [ "${{ needs.formatting.result }}" != "success" ] || [ "${{ needs.linting.result }}" != "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Quality gate FAILED - Please fix formatting and linting issues" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Quality gate PASSED" >> $GITHUB_STEP_SUMMARY
